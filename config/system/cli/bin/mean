#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander'),
  pkg = require('../package.json'),
  version = pkg.version,
  os = require('os'),
  fs = require('fs');

program
  .version(version)
  .usage('[options] [npm module]')
  .option('-v, --verbose', 'verbose messaging')
  .parse(process.argv);

// Path
var path = program.args;

(function mean(params) {
  var op = params[0],
    module = params[1];
  switch (op) {
    case 'install':
      install(module);
      break;
    case 'uninstall':
      uninstall(module);
      break;
    case 'list':
      list();
      break;
    default:
      console.log('Try [install/uninstall/list] !');
      break;
  }
})(path);

function list() {
  fs.readdir('./modules', function(err, files) {
    if (err) console.log(err);
    remaining = files.length;
    console.log(' MEAN Modules List:');
    console.log(' ==================');
    files.forEach(function(file) {
      fs.readFile('./modules/' + file + '/package.json', function(fileErr, data) {
        if (err) throw fileErr;
        var json = JSON.parse(data.toString());
        console.log(' ' + json.name + '@' + json.version);
      });
    });
  });
}

function uninstall(module) {
  var rimraf = require('rimraf');
  rimraf('./modules/' + module + '/', function(err) {
    if (err) throw err;
  })
}

function install(module) {
  var npm = require("npm");
  fs.exists('./modules', function(exists) {
    if (exists) return npminstall(module)
    fs.mkdir('./modules', function(err) {
      if (err) console.log(err);
      npminstall(module);
    });
  });


  function npminstall(module) {
    npm.load(npm.config, function(err) {
      npm.commands.install([module], function(er, data) {
        if (er) console.log(er)
        if (err) return console.log(err);
        fs.rename('./node_modules/' + module, './modules/' + module, function(err) {
          if (err) console.log(err);
        })
      });
      npm.on("log", function(message) {
        console.log(message);
      });
    });
  }

}